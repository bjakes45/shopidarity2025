{% extends "base.html" %}
{% block title %}Product {{ product.upc }}{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden">

  <!-- Sidebar -->
  <aside class="w-40 sm:w-56 md:w-64 shrink-0 bg-gray-100 p-4 sm:p-6 overflow-y-auto text-sm sm:text-base">
    <h2 class="text-lg sm:text-lg font-semibold mb-4 sm:mb-6 text-gray-800">
      <a href="{{ url_for('product_detail', upc=product.upc) }}" class="text-blue-600 hover:underline">
        {% if product.upc|length in [12,13]%}UPC:{% else %}PLU:{% endif %} {{ product.upc }}
      </a>
    </h2>
    {% if current_user.is_authenticated and product.status.value == "approved"%}
    <!-- Centered Inline Actions -->
    <div class="flex flex-wrap justify-center items-center gap-2">
      <!-- Favorite / Unfavorite -->
      {% set is_favorite = current_user.favorites | selectattr('product', 'equalto', product) | list | length > 0 %}
      {% if is_favorite %}
      <!-- Show unfavorite button -->
      <form method="post" action="{{ url_for('unfavorite', upc=product.upc) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="text-red-600 border border-red-600 px-3 py-1 rounded hover:bg-red-50 transition text-sm">
          ❤️ Remove Favorite
        </button>
      </form>
      {% else %}
      <!-- Show favorite button -->
      <form method="post" action="{{ url_for('favorite', upc=product.upc) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="text-blue-600 border border-blue-600 px-3 py-1 rounded hover:bg-blue-50 transition text-sm">
          ❤️ Favorite
        </button>
      </form>
      {% endif %}

      <!-- Rating Form -->
      {% set user_rating = current_user.ratings | selectattr('product', 'equalto', product) | list | first %}
      <form action="{{ url_for('rate', upc=product.upc) }}" method="POST" class="inline flex items-center space-x-1">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="product_upc" value="{{ product.upc }}">
        <label for="rating_{{ product.upc }}" class="text-xs">Rate:</label>
        <select name="score" id="rating_{{ product.upc }}" class="text-xs border rounded px-1 py-0.5">
          <option value="">--</option>
          {% for i in range(1, 6) %}
          <option value="{{ i }}" {% if user_rating and user_rating.score == i %}selected{% endif %}>{{ i }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="text-xs text-green-600 hover:underline">✔</button>
      </form>

      <!-- Average Rating -->
      <div class="text-center mt-1">
        <h3 class="font-medium text-sm">Average Rating:</h3>
        <p class="text-yellow-600 text-lg">
          {% set avg = product.average_rating() %}
          {{ "%.2f"|format(avg) if avg is not none else '–' }}
        </p>
      </div>
    </div>
    {% else %}
    <div class="flex flex-wrap gap-4 items-center mt-2">
      <div>
        <h3 class="font-semibold">Average Rating:</h3>
        <p class="text-yellow-600 text-xl">{{ average_rating }}</p>
      </div>
      <div>        
        <p class="text-gray-600 mt-4">Sign in to rate, comment, or favorite this product.</p>
      </div>
    </div>
    {% endif %}

    <nav class="flex flex-col gap-3">
      <a href="{{ url_for('product_comments', upc=product.upc) }}" class="text-gray-700 font-medium hover:text-blue-600 hover:underline">
        All Comments
      </a>
      {% if product.nutriments %}
      <a href="{{ url_for('product_nutrifacts', upc=product.upc) }}" class="text-gray-700 font-medium hover:text-blue-600 hover:underline">
        Nutrifacts
      </a>
      {% endif %}
      {% if product.deals %}
      <a href="{{ url_for('product_deals', upc=product.upc) }}" class="text-gray-700 font-medium hover:text-blue-600 hover:underline">
        Deals
      </a>
      {% endif %}

      {% if current_user.is_authenticated and product.status.value == "approved" %}

      <a href="{{ url_for('product_new_deal', upc=product.upc) }}"
      class="mt-4 inline-flex items-center gap-2 px-3 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition w-full justify-center text-sm">
      <span class="text-lg leading-none">+</span>
      Add New Deal
    </a>
    {% endif %}
  </nav>
</aside>


<!-- Main Content -->
<main class="flex-1 overflow-y-auto lg:overflow-y-visible p-6 space-y-10">
  {% block detail %}{% endblock %}
</main>

</div>
{% endblock %}
